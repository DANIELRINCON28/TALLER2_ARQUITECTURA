<!-- 
  PÃ¡gina de detalle de pedido.
  TraducciÃ³n directa de order_show.php manteniendo la misma estructura y funcionalidad.
-->
{% extends 'orders/base.html' %}

{% block content %}
<!-- Equivalente a: <?php if (!$order): ?> -->
{% if not order %}
  <p class="muted">Pedido no encontrado.</p>
{% else %}
  <!-- 
    Equivalente a: 
    <?php else: $o=$order['order']; ?>
    <h1 class="h">Pedido #<?= (int)$o['id'] ?></h1>
  -->
  <h1 class="h">Pedido #{{ order.order.id }}</h1>
  
  <!-- 
    Equivalente a: 
    <p><strong>Cliente:</strong> <?= htmlspecialchars($o['customer_email']) ?> â€¢ 
    <strong>DirecciÃ³n:</strong> <?= htmlspecialchars($o['address']) ?></p>
  -->
  <p>
    <strong>Cliente:</strong> {{ order.order.customer_email }} â€¢ 
    <strong>DirecciÃ³n:</strong> {{ order.order.address }}
  </p>
  
  <!-- 
    Equivalente a: 
    <p><strong>Prioridad:</strong> <?= htmlspecialchars($o['priority']) ?> â€¢ 
    <strong>Fragilidad:</strong> <?= htmlspecialchars($o['fragility']) ?> â€¢ 
    <strong>Peso total:</strong> <?= (int)$o['total_weight'] ?> g</p>
  -->
  <p>
    <strong>Prioridad:</strong> {{ order.order.priority }} â€¢ 
    <strong>Fragilidad:</strong> {{ order.order.fragility }} â€¢ 
    <strong>Peso total:</strong> {{ order.order.total_weight }} g
  </p>

  <!-- Equivalente a: <h2 class="hh">Items</h2> -->
  <h2 class="hh">Items</h2>
  <ul class="list">
    <!-- 
      Equivalente a: 
      <?php foreach ($order['items'] as $it): ?>
        <li class="list-item"><?= htmlspecialchars($it['name']) ?> Ã— <?= (int)$it['quantity'] ?></li>
      <?php endforeach; ?>
    -->
    {% for item in order.items %}
      <li class="list-item">{{ item.product.name }} Ã— {{ item.quantity }}</li>
    {% endfor %}
  </ul>

  <!-- Equivalente a: <h2 class="hh">EnvÃ­o</h2> -->
  <h2 class="hh">EnvÃ­o</h2>
  <!-- Equivalente a: <?php if (!$shipment): ?> -->
  {% if not shipment %}
    <p class="muted">EnvÃ­o no registrado.</p>
  {% else %}
    <!-- 
      Equivalente a: 
      <p><strong>Proveedor:</strong> <?= htmlspecialchars($shipment['provider']) ?> â€¢ 
      <strong>Tracking:</strong> <?= htmlspecialchars($shipment['tracking_id']) ?> â€¢ 
      <strong>Estado:</strong> <?= htmlspecialchars($shipment['status']) ?></p>
    -->
    <p>
      <strong>Proveedor:</strong> {{ shipment.provider }} â€¢ 
      <strong>Tracking:</strong> {{ shipment.tracking_id }} â€¢ 
      <strong>Estado:</strong> {{ shipment.status }}
    </p>
  {% endif %}

  <!-- NUEVA SECCIÃ“N: InformaciÃ³n de Patrones de DiseÃ±o -->
  {% if patterns_info %}
  <h2 class="hh">ğŸ¯ Patrones de DiseÃ±o Aplicados</h2>
  
  <!-- PatrÃ³n Builder -->
  {% if patterns_info.builder_info %}
  <div class="card" style="margin-bottom: 1rem; padding: 1rem; border-left: 4px solid #007bff;">
    <h3>ğŸ”¨ {{ patterns_info.builder_info.pattern }}</h3>
    <p><strong>DescripciÃ³n:</strong> {{ patterns_info.builder_info.description }}</p>
    <ul>
      <li><strong>CÃ³digo paquete:</strong> {{ patterns_info.builder_info.package_code }}</li>
      <li><strong>Peso calculado:</strong> {{ patterns_info.builder_info.weight_calculated }}g</li>
      <li><strong>Fragilidad manejada:</strong> 
        {% if patterns_info.builder_info.fragility_handled %}âœ… SÃ­{% else %}âŒ No{% endif %}
      </li>
    </ul>
  </div>
  {% endif %}

  <!-- PatrÃ³n Strategy -->
  {% if patterns_info.strategy_info %}
  <div class="card" style="margin-bottom: 1rem; padding: 1rem; border-left: 4px solid #28a745;">
    <h3>ğŸ“Š {{ patterns_info.strategy_info.pattern }}</h3>
    <p><strong>DescripciÃ³n:</strong> {{ patterns_info.strategy_info.description }}</p>
    <ul>
      <li><strong>Proveedor seleccionado:</strong> {{ patterns_info.strategy_info.provider_selected }}</li>
      <li><strong>Factores de decisiÃ³n:</strong> {{ patterns_info.strategy_info.decision_factors }}</li>
    </ul>
  </div>
  {% endif %}

  <!-- PatrÃ³n Adapter -->
  {% if patterns_info.adapter_info %}
  <div class="card" style="margin-bottom: 1rem; padding: 1rem; border-left: 4px solid #ffc107;">
    <h3>ğŸ”Œ {{ patterns_info.adapter_info.pattern }}</h3>
    <p><strong>DescripciÃ³n:</strong> {{ patterns_info.adapter_info.description }}</p>
    <ul>
      <li><strong>Proveedor integrado:</strong> {{ patterns_info.adapter_info.provider_integrated }}</li>
      <li><strong>Tracking generado:</strong> {{ patterns_info.adapter_info.tracking_generated }}</li>
      <li><strong>Interfaz unificada:</strong> 
        {% if patterns_info.adapter_info.unified_interface %}âœ… Implementada{% else %}âŒ No{% endif %}
      </li>
    </ul>
  </div>
  {% endif %}

  <!-- PatrÃ³n Observer -->
  {% if patterns_info.observer_info %}
  <div class="card" style="margin-bottom: 1rem; padding: 1rem; border-left: 4px solid #dc3545;">
    <h3>ğŸ”” {{ patterns_info.observer_info.pattern }}</h3>
    <p><strong>DescripciÃ³n:</strong> {{ patterns_info.observer_info.description }}</p>
    <ul>
      <li><strong>Notificaciones enviadas:</strong> {{ patterns_info.observer_info.notifications_sent }}</li>
      <li><strong>Canales utilizados:</strong> 
        {% for channel in patterns_info.observer_info.channels_used %}
          <span class="chip">{{ channel }}</span>
        {% endfor %}
      </li>
      <li><strong>NotificaciÃ³n automÃ¡tica:</strong> 
        {% if patterns_info.observer_info.auto_notification %}âœ… Activada{% else %}âŒ Desactivada{% endif %}
      </li>
    </ul>
  </div>
  {% endif %}

  <!-- BotÃ³n para simular cambio de estado (Observer) -->
  <div class="actions mt">
    <button onclick="simulateStatusChange('dispatched')" class="btn">ğŸ“¦ Simular Despacho</button>
    <button onclick="simulateStatusChange('in_transit')" class="btn">ğŸšš Simular En TrÃ¡nsito</button>
    <button onclick="simulateStatusChange('delivered')" class="btn primary">âœ… Simular Entrega</button>
  </div>

  <script>
    function simulateStatusChange(status) {
      fetch(`/api/order/{{ order.order.id }}/status/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `status=${status}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(`âœ… Estado cambiado a ${status}!\nNotificaciones enviadas: ${data.notifications_sent.length}\nPatrÃ³n usado: ${data.pattern_used}`);
          location.reload();
        } else {
          alert('âŒ Error al cambiar estado: ' + data.error);
        }
      })
      .catch(error => {
        alert('âŒ Error de conexiÃ³n: ' + error);
      });
    }
  </script>
  {% endif %}

  <!-- Equivalente a: <p class="note">Revisa la tabla <code>notifications</code> para ver los "mensajes enviados" (simulados).</p> -->
  <p class="note">
    ğŸ“Š Los patrones de diseÃ±o se ejecutan automÃ¡ticamente al crear el pedido.<br>
    ğŸ” Revisa la consola del servidor para ver los logs detallados de cada patrÃ³n.<br>
    ğŸ”” Usa los botones de arriba para simular cambios de estado con el patrÃ³n Observer.
  </p>
{% endif %}
{% endblock %}